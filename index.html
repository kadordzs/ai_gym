<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoBoost AI - إتقان اللغة بالذكاء الاصطناعي</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
      // On page load, dynamically replace the icon placeholders
      document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
      });
    </script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            scroll-behavior: smooth;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transform: scale(1);
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1.5rem;
            max-width: 90%;
            width: 800px;
            z-index: 50;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            max-height: 90vh;
            overflow-y: auto;
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .story-word {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 2px 3px;
            border-radius: 4px;
        }
        .story-word:hover {
            background-color: #dbeafe; /* blue-100 */
        }
        .story-word.selected {
            background-color: #93c5fd; /* blue-300 */
            color: black;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        <p class="mt-4 text-lg font-semibold text-slate-700">جاري الاتصال بالخادم...</p>
    </div>

    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-30 shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i data-lucide="languages" class="text-blue-500 w-8 h-8"></i>
                    <h1 class="text-2xl font-bold text-slate-800">LingoBoost AI</h1>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium">اختر لغة التعلم:</span>
                    <button id="lang-en" class="btn btn-secondary !px-4 !py-2">English</button>
                    <button id="lang-fr" class="btn btn-secondary !px-4 !py-2">Français</button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-6 space-y-8">
            <!-- User Info & Progress -->
            <div class="card">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">مرحباً بك في رحلة تعلمك!</h2>
                        <p id="welcome-message" class="text-slate-500 mt-1">مستعد ليوم جديد من التعلم؟</p>
                    </div>
                    <div class="text-center">
                        <p class="text-lg font-semibold text-blue-600">لغة التعلم الحالية</p>
                        <p id="current-lang-display" class="text-3xl font-bold"></p>
                    </div>
                    <div class="text-center">
                        <p class="text-lg font-semibold text-green-600">الكلمات المتقنة</p>
                        <p id="learned-words-count" class="text-3xl font-bold">0</p>
                    </div>
                     <div class="text-center">
                        <p class="text-lg font-semibold text-amber-600">الإنجازات</p>
                        <p id="achievements-count" class="text-3xl font-bold">0</p>
                    </div>
                </div>
            </div>

            <!-- Learning Grid -->
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- AI Vocabulary Builder -->
                <div id="vocab-card" class="card cursor-pointer md:col-span-2 lg:col-span-1 lg:row-span-2 bg-green-50 border-green-200">
                     <h3 class="text-xl font-bold mb-2 flex items-center gap-2"><i data-lucide="sparkles" class="text-green-500"></i> بنّاء المفردات الذكي</h3>
                     <p class="text-slate-500 mb-4">احصل على كلمات وجمل جديدة من الذكاء الاصطناعي لتوسيع مفرداتك.</p>
                     <button id="generate-vocab-btn" class="btn bg-green-500 text-white hover:bg-green-600 w-full">
                         <i data-lucide="brain-circuit" class="mr-2"></i> ولّد لي مفردات جديدة
                     </button>
                </div>
                
                <!-- AI Story Reader -->
                <div id="story-card" class="card cursor-pointer">
                     <h3 class="text-xl font-bold mb-2 flex items-center gap-2"><i data-lucide="bot" class="text-purple-500"></i> قصص صوتية تفاعلية</h3>
                     <p class="text-slate-500">اقرأ واستمع لقصص AI، واحصل على شرح فوري للكلمات.</p>
                </div>
                
                <!-- Learning Games -->
                <div id="games-card" class="card cursor-pointer">
                     <h3 class="text-xl font-bold mb-2 flex items-center gap-2"><i data-lucide="gamepad-2" class="text-red-500"></i> لعبة مطابقة الكلمات</h3>
                     <p class="text-slate-500">اختبر معلوماتك بالكلمات التي تعلمتها.</p>
                </div>
            </div>

            <!-- Study Ambiance -->
            <div class="card">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="music" class="text-sky-500"></i> أجواء دراسية</h3>
                <div class="flex justify-between items-center mb-4">
                    <p class="text-slate-500">اختر قائمة التشغيل التي تناسب مزاجك.</p>
                    <div id="playlist-selector" class="flex gap-2">
                        <button data-playlist="37i9dQZF1DX4sWSpwq3LiO" class="playlist-btn btn btn-secondary !px-3 !py-1.5 text-sm">Study</button>
                        <button data-playlist="37i9dQZF1DWV7EzJMK2FUI" class="playlist-btn btn btn-secondary !px-3 !py-1.5 text-sm">Snowfall</button>
                        <button data-playlist-id="37i9dQZF1DX3YSRonYSFXF" class="playlist-btn btn btn-secondary !px-3 !py-1.5 text-sm">Sad</button>
                    </div>
                </div>
                <iframe id="spotify-player" style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DX4sWSpwq3LiO?utm_source=generator" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden"></div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- HARDCODED CONFIG & STATE ---
        const firebaseConfig = {
          apiKey: "AIzaSyD5W-u3aluVA6ySNB2sWgzJ1nLzEPiQRhg",
          authDomain: "engai-541c8.firebaseapp.com",
          projectId: "engai-541c8",
          storageBucket: "engai-541c8.appspot.com",
          messagingSenderId: "866830883015",
          appId: "1:866830883015:web:3cca96f20ac8c36cc846e2",
          measurementId: "G-G3B46KKX3C"
        };
        const geminiApiKey = "AIzaSyD2dY5BdDz8Q_Bixchg3XNkaHA36wBVMfA";
        const appId = 'LingoBoostAI-Public'; 

        let app, db, auth, userId;
        
        const state = {
            language: 'en', // 'en' or 'fr'
            userData: {
                learnedWords_en: [],
                learnedWords_fr: [],
                achievements: [],
            },
            isAuthReady: false,
        };
        
        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const modalContainer = document.getElementById('modal-container');

        // --- INITIALIZATION ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await authUser();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingOverlay.innerHTML = '<p class="text-red-500">فشل تهيئة Firebase. قد تكون إعدادات المشروع غير صحيحة.</p>';
            }
        }

        async function authUser() {
            try {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        setupUserListener();
                        state.isAuthReady = true;
                        hideLoading();
                    }
                });
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                loadingOverlay.innerHTML = `<p class="text-red-500 p-4 text-center">فشل المصادقة. <br>تأكد من تفعيل 'Anonymous sign-in' وإضافة الدومين الخاص بك في إعدادات Firebase Authentication.</p>`;
            }
        }
        
        function setupUserListener() {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/userData`, 'profile');
            return onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.userData = { ...state.userData, ...data };
                } else {
                    saveUserData(); // Create initial document
                }
                updateUI();
            }, (error) => console.error("Firestore listener error:", error));
        }
        
        async function saveUserData() {
            if (!userId || !state.isAuthReady) return;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/userData`, 'profile');
                await setDoc(userDocRef, state.userData, { merge: true });
            } catch (error) {
                console.error("Error saving user data: ", error);
            }
        }

        // --- UI & LOGIC ---
        function updateUI() {
            document.getElementById('lang-en').classList.toggle('btn-primary', state.language === 'en');
            document.getElementById('lang-en').classList.toggle('btn-secondary', state.language !== 'en');
            document.getElementById('lang-fr').classList.toggle('btn-primary', state.language === 'fr');
            document.getElementById('lang-fr').classList.toggle('btn-secondary', state.language !== 'fr');
            document.getElementById('current-lang-display').textContent = state.language === 'en' ? 'الإنجليزية' : 'الفرنسية';
            const learnedWords = state.userData[`learnedWords_${state.language}`] || [];
            document.getElementById('learned-words-count').textContent = learnedWords.length;
            const achievementsCount = state.userData.achievements?.length || 0;
            document.getElementById('achievements-count').textContent = achievementsCount;
        }

        function changeLanguage(lang) {
            state.language = lang;
            updateUI();
        }

        function speak(text, lang) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel(); // Cancel any previous speech
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang === 'en' ? 'en-US' : 'fr-FR';
                speechSynthesis.speak(utterance);
            } else {
                console.warn('Speech synthesis not supported.');
            }
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        // --- MODALS ---
        function showModal(content, widthClass = 'w-[800px]') {
            modalContainer.innerHTML = `
                <div class="modal-backdrop" id="modal-backdrop">
                    <div class="modal-content animate-fade-in-up ${widthClass}">
                        <button id="close-modal-btn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        ${content}
                    </div>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            lucide.createIcons();
            document.getElementById('modal-backdrop').addEventListener('click', (e) => {
                if (e.target.id === 'modal-backdrop') closeModal();
            });
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        }

        function closeModal() {
            speechSynthesis.cancel(); // Stop any speech on modal close
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        }

        // --- AI VOCABULARY BUILDER ---
        async function handleGenerateVocab() {
            const content = `
                <div id="vocab-content" class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-500 mx-auto"></div>
                    <p class="mt-4 text-slate-600">الذكاء الاصطناعي يقوم بتوليد مفردات جديدة لك...</p>
                </div>
            `;
            showModal(content, 'w-[600px]');
            
            const langName = state.language === 'en' ? 'English' : 'French';
            const prompt = `Generate 3 new vocabulary items for a beginner learning ${langName}. For each item, provide a word, a simple example sentence using the word, and a simple Arabic definition. Respond in a valid JSON array format.`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "word": { "type": "STRING" },
                        "sentence": { "type": "STRING" },
                        "definition_ar": { "type": "STRING" }
                    },
                    required: ["word", "sentence", "definition_ar"]
                }
            };

            try {
                const response = await callGemini(prompt, schema);
                displayAIVocab(response);
            } catch (error) {
                document.getElementById('vocab-content').innerHTML = `<p class="text-red-500">حدث خطأ أثناء توليد المفردات. حاول مرة أخرى.</p>`;
                console.error("Vocab Generation Error:", error);
            }
        }
        
        function displayAIVocab(vocabArray) {
            let vocabHTML = `<h3 class="text-2xl font-bold mb-6 text-center">مفردات جديدة</h3><div class="space-y-4">`;
            vocabArray.forEach((item, index) => {
                vocabHTML += `
                    <div class="bg-slate-50 p-4 rounded-lg border">
                        <div class="flex items-center justify-between">
                            <h4 class="text-2xl font-bold text-blue-600">${item.word}</h4>
                            <button class="speak-btn btn btn-secondary !p-2" data-text="${item.word}"><i data-lucide="volume-2"></i></button>
                        </div>
                        <p class="text-slate-600 my-2"><em>${item.sentence}</em></p>
                        <p class="text-sm text-green-700 font-semibold">${item.definition_ar}</p>
                        <div class="text-left mt-2">
                             <button class="learn-word-btn btn btn-primary !py-1 !px-3 text-sm" data-word="${item.word}">أتقنتها</button>
                        </div>
                    </div>
                `;
            });
            vocabHTML += `</div>`;
            document.getElementById('modal-container').querySelector('.modal-content').innerHTML += vocabHTML;
            document.getElementById('vocab-content').remove();
            
            lucide.createIcons();

            document.querySelectorAll('.speak-btn').forEach(btn => {
                btn.addEventListener('click', (e) => speak(e.currentTarget.dataset.text, state.language));
            });
            document.querySelectorAll('.learn-word-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const word = e.currentTarget.dataset.word;
                    learnWord(word);
                    e.currentTarget.textContent = 'تم ✓';
                    e.currentTarget.disabled = true;
                });
            });
        }
        
        function learnWord(word) {
            const key = `learnedWords_${state.language}`;
            if (!state.userData[key]) state.userData[key] = [];
            
            if (!state.userData[key].find(item => item.word === word)) {
                state.userData[key].push({word: word, learnedAt: new Date()});
                saveUserData();
            }
        }

        // --- AI STORY READER ---
        function showStoryModal() {
            const content = `
                <div class="grid grid-cols-3 gap-6">
                    <div id="story-display" class="col-span-2 p-4 bg-slate-50 border rounded-lg h-[65vh] overflow-y-auto">
                        <div id="story-placeholder" class="text-center mt-20">
                           <i data-lucide="file-text" class="w-16 h-16 text-slate-300 mx-auto"></i>
                           <p class="text-slate-500 mt-4">اضغط على "إنشاء قصة" للبدء.</p>
                        </div>
                        <p id="story-content" class="text-2xl/loose"></p>
                    </div>
                    <div id="story-sidebar" class="col-span-1 space-y-4">
                         <h3 class="text-xl font-bold text-center">لوحة التحكم</h3>
                         <button id="generate-story-btn" class="btn btn-primary w-full"><i data-lucide="wand" class="mr-2"></i> إنشاء قصة</button>
                         <button id="speak-story-btn" class="btn btn-secondary w-full" disabled><i data-lucide="volume-2" class="mr-2"></i> قراءة القصة</button>
                         <div id="word-explanation-box" class="bg-blue-50 p-4 rounded-lg border-blue-200 border min-h-[150px]">
                            <h4 class="font-bold mb-2">شرح الكلمة</h4>
                            <p id="explanation-text" class="text-slate-600">اضغط على أي كلمة في النص لعرض شرحها هنا.</p>
                         </div>
                    </div>
                </div>
            `;
            showModal(content);
            document.getElementById('generate-story-btn').addEventListener('click', generateStory);
            document.getElementById('speak-story-btn').addEventListener('click', () => {
                const storyText = document.getElementById('story-content').innerText;
                speak(storyText, state.language);
            });
        }

        async function generateStory() {
            const placeholder = document.getElementById('story-placeholder');
            const storyContent = document.getElementById('story-content');
            const explainText = document.getElementById('explanation-text');
            const speakBtn = document.getElementById('speak-story-btn');
            const genBtn = document.getElementById('generate-story-btn');

            storyContent.innerHTML = '';
            placeholder.innerHTML = `<div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto"></div><p class="mt-2">جاري كتابة القصة...</p>`;
            placeholder.classList.remove('hidden');
            explainText.textContent = "اضغط على أي كلمة في النص لعرض شرحها هنا.";
            speakBtn.disabled = true;
            genBtn.disabled = true;

            const langName = state.language === 'en' ? 'English' : 'French';
            const prompt = `Write a very short and simple story (about 40-60 words) for a beginner learning ${langName}. The story must be entirely in ${langName}.`;

            try {
                const text = await callGemini(prompt);
                placeholder.classList.add('hidden');
                speakBtn.disabled = false;
                
                storyContent.innerHTML = text.split(/(\s+)/).map(word => {
                    if (word.trim() === '') return word; // Keep spaces
                    const cleanWord = word.replace(/[.,!?]/g, '');
                    return `<span class="story-word" data-word="${cleanWord}">${word}</span>`;
                }).join('');

                document.querySelectorAll('.story-word').forEach(span => {
                    span.addEventListener('click', (e) => {
                        document.querySelectorAll('.story-word.selected').forEach(el => el.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        explainWord(e.currentTarget.dataset.word);
                    });
                });
            } catch (error) {
                 placeholder.innerHTML = `<p class="text-red-500">فشل إنشاء القصة.</p>`;
            } finally {
                genBtn.disabled = false;
            }
        }
        
        async function explainWord(word) {
             const explainText = document.getElementById('explanation-text');
             explainText.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-blue-500"></div>`;
             
             const langName = state.language === 'en' ? 'English' : 'French';
             const prompt = `Explain the ${langName} word "${word}" in 2-3 simple Arabic words for a language learner. Just the Arabic explanation.`;

             try {
                const explanation = await callGemini(prompt);
                explainText.textContent = explanation;
             } catch (error) {
                explainText.textContent = "لا يمكن شرح هذه الكلمة.";
             }
        }
        
        // --- LEARNING GAMES ---
        function showGamesModal() {
            const learnedWords = state.userData[`learnedWords_${state.language}`] || [];
            if (learnedWords.length < 4) {
                showModal(`<div class="text-center"><h3 class="text-2xl font-bold mb-4">لعبة مطابقة الكلمات</h3><p class="text-slate-500">يجب أن تتقن 4 كلمات على الأقل لتتمكن من اللعب. استمر في التعلم!</p></div>`, 'w-[500px]');
                return;
            }
            
            // Select 4 random learned words
            const gameWords = [...learnedWords].sort(() => 0.5 - Math.random()).slice(0, 4);
            const gameDefs = [...gameWords].sort(() => 0.5 - Math.random()); // Shuffled definitions
            
            let content = `<h3 class="text-2xl font-bold mb-6 text-center">لعبة مطابقة الكلمات</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div id="words-col" class="space-y-3">
                        ${gameWords.map((item, i) => `<button class="game-btn w-full btn btn-secondary" data-type="word" data-id="${i}">${item.word}</button>`).join('')}
                    </div>
                    <div id="defs-col" class="space-y-3">
                         ${gameDefs.map((item, i) => `<button class="game-btn w-full btn btn-secondary" data-type="def" data-id="${i}">${item.word}</button>`).join('')}
                    </div>
                </div>
            `;
            showModal(content, 'w-[700px]');
            
            // This is a placeholder for definitions, we will fetch them with AI
            const defsContainer = document.getElementById('defs-col');
            defsContainer.innerHTML = `<div class="text-center col-span-1"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto"></div><p>جاري توليد التعاريف...</p></div>`;

            generateGameDefinitions(gameWords.map(w => w.word)).then(definitions => {
                const shuffledDefs = [...definitions].sort(() => 0.5 - Math.random());
                 defsContainer.innerHTML = shuffledDefs.map(item => `<button class="game-btn w-full btn btn-secondary" data-type="def" data-word="${item.word}">${item.definition_ar}</button>`).join('');
                setupGameLogic();
            });
        }
        
        async function generateGameDefinitions(words) {
            const langName = state.language === 'en' ? 'English' : 'French';
            const prompt = `For each word in this list: [${words.join(', ')}], provide a very short and simple definition in Arabic. Respond in a valid JSON array of objects, where each object has a "word" and "definition_ar" key.`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "word": { "type": "STRING" },
                        "definition_ar": { "type": "STRING" }
                    },
                    required: ["word", "definition_ar"]
                }
            };
            return await callGemini(prompt, schema);
        }

        function setupGameLogic() {
            let selectedWord = null;
            let selectedDef = null;
            let correctPairs = 0;

            document.querySelectorAll('.game-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.currentTarget;
                    const type = target.dataset.type;
                    
                    if (type === 'word') {
                        if (selectedWord) selectedWord.classList.replace('btn-primary', 'btn-secondary');
                        selectedWord = target;
                        target.classList.replace('btn-secondary', 'btn-primary');
                    } else {
                        if (selectedDef) selectedDef.classList.replace('btn-primary', 'btn-secondary');
                        selectedDef = target;
                        target.classList.replace('btn-secondary', 'btn-primary');
                    }
                    
                    if (selectedWord && selectedDef) {
                        if (selectedWord.dataset.word === selectedDef.dataset.word) {
                            selectedWord.classList.replace('btn-primary', 'bg-green-500');
                            selectedDef.classList.replace('btn-primary', 'bg-green-500');
                            selectedWord.disabled = true;
                            selectedDef.disabled = true;
                            selectedWord = null;
                            selectedDef = null;
                            correctPairs++;
                            if (correctPairs === 4) {
                                showModal(`<div class="text-center"><h3 class="text-2xl font-bold mb-4 text-green-600">أحسنت!</h3><p>لقد فزت باللعبة بنجاح.</p></div>`, 'w-[400px]');
                            }
                        } else {
                            selectedWord.classList.add('bg-red-500');
                            selectedDef.classList.add('bg-red-500');
                            setTimeout(() => {
                                selectedWord.classList.remove('bg-red-500');
                                selectedDef.classList.remove('bg-red-500');
                                selectedWord.classList.replace('btn-primary', 'btn-secondary');
                                selectedDef.classList.replace('btn-primary', 'btn-secondary');
                                selectedWord = null;
                                selectedDef = null;
                            }, 800);
                        }
                    }
                });
            });
             document.querySelectorAll('#words-col .game-btn').forEach(btn => {
                btn.dataset.word = btn.textContent;
            });
        }


        // --- GEMINI API HELPER ---
        async function callGemini(prompt, schema = null) {
            let payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };
            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorBody}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                return schema ? JSON.parse(text) : text;
            } else {
                throw new Error("No content generated or invalid response structure.");
            }
        }

        // --- EVENT LISTENERS ---
        document.getElementById('lang-en').addEventListener('click', () => changeLanguage('en'));
        document.getElementById('lang-fr').addEventListener('click', () => changeLanguage('fr'));
        document.getElementById('generate-vocab-btn').addEventListener('click', handleGenerateVocab);
        document.getElementById('story-card').addEventListener('click', showStoryModal);
        document.getElementById('games-card').addEventListener('click', showGamesModal);
        
        document.querySelectorAll('.playlist-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const playlistId = e.currentTarget.dataset.playlist;
                const spotifyPlayer = document.getElementById('spotify-player');
                spotifyPlayer.src = `https://open.spotify.com/embed/playlist/${playlistId}?utm_source=generator`;
                document.querySelectorAll('.playlist-btn').forEach(b => b.classList.replace('btn-primary','btn-secondary'));
                e.currentTarget.classList.replace('btn-secondary','btn-primary');
            });
        });


        // --- START APP ---
        window.addEventListener('load', initializeFirebase);

    </script>
</body>
</html>
